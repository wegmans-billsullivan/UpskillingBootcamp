# ADR-003: Event Hubs

## Status

- Accepted (2021-07-23)

## Context

- Event Hubs can have between 1 and 32 partitions, when a partition key is provided is ensures that same partition key will always be sent to the same partition, this ensures data for the same entity are processed in order, e.g. customer updates
- EventHub output bindings in Function Apps do not support partition keys
- EventHubTrigger requires Manage/Listen/Send authorization rules for it to be able to scale-out the Function App
- Store location data does not have a data hub, only an Enterprise Services API
- AEP requires a one-to-one relationship between dataset and Event Hub, it cannot take one source and populate multiple datasets
- AEP merges record updates with the latest timestamp, you cannot remove an identifer from one customer profile and add it to another, to get around this they created datasets where the loyalty number and wegmans.com identifiers allow the golden record identifier to change
- Sale transactions need to be split between loyalty number and email address transactions, only send to one or the other, never both; this allows them to link between the customer profile identifiers, it cannot link between optional identifiers, e.g. not all sales will have loyalty or wegmans.com identifiers

## Decision

- Use EventHubTrigger for consuming streaming data sources
- Use EventHubProducerClient to send data and set an appropriate partition key
- Use TimerTrigger for scheduled updates of data that does not support event driven or data streaming

## Consequences

- Each time an identifer is added, e.g. CLM, a new dataset will potentially be needed
- Event Hub standard SKU only supports up to 10 Event Hubs per namespace, we will need to add a secondary Event Hub Namespace when we exceed 10 Event Hubs in the current namespace
- Event Hub Premium is $750/month, only upgrade from the standard SKU and scaling out to multiple namespaces when the cost exceeds that; Premium SKU supports up to 100 Event Hubs per namespace

![Event Stream](../event-streams.drawio.png)
